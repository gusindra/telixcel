"use strict";!function(factory){"object"==typeof module&&"object"==typeof module.exports?factory(require("jquery"),window,document):factory(jQuery,window,document)}((function($,window,document,undefined){var OrgChart=function(elem,opts){this.$chartContainer=$(elem),this.opts=opts,this.defaultOptions={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,visibleLevel:999,chartClass:"",exportButton:!1,exportButtonName:"Export",exportFilename:"OrgChart",exportFileextension:"png",parentNodeSymbol:"oci-leader",draggable:!1,direction:"t2b",pan:!1,zoom:!1,zoominLimit:7,zoomoutLimit:.5}};OrgChart.prototype={init:function(opts){var that=this;this.options=$.extend({},this.defaultOptions,this.opts,opts);var $chartContainer=this.$chartContainer;this.$chart&&this.$chart.remove();var data=this.options.data,$chart=this.$chart=$("<div>",{data:{options:this.options},class:"orgchart"+(""!==this.options.chartClass?" "+this.options.chartClass:"")+("t2b"!==this.options.direction?" "+this.options.direction:""),click:function(event){$(event.target).closest(".node").length||$chart.find(".node.focused").removeClass("focused")}});"undefined"!=typeof MutationObserver&&this.triggerInitEvent();var $root=$chart.append($('<ul class="nodes"><li class="hierarchy"></li></ul>')).find(".hierarchy");return"object"===$.type(data)?data instanceof $?this.buildHierarchy($root,this.buildJsonDS(data.children()),0,this.options):this.buildHierarchy($root,this.options.ajaxURL?data:this.attachRel(data,"00")):($chart.append('<i class="oci oci-spinner spinner"></i>'),$.ajax({url:data,dataType:"json"}).done((function(data,textStatus,jqXHR){that.buildHierarchy($root,that.options.ajaxURL?data:that.attachRel(data,"00"),0,that.options)})).fail((function(jqXHR,textStatus,errorThrown){console.log(errorThrown)})).always((function(){$chart.children(".spinner").remove()}))),$chartContainer.append($chart),this.options.exportButton&&!$(".oc-export-btn").length&&this.attachExportButton(),this.options.pan&&this.bindPan(),this.options.zoom&&this.bindZoom(),this},triggerInitEvent:function(){var that=this,mo=new MutationObserver((function(mutations){mo.disconnect();initTime:for(var i=0;i<mutations.length;i++)for(var j=0;j<mutations[i].addedNodes.length;j++)if(mutations[i].addedNodes[j].classList.contains("orgchart")){that.options.initCompleted&&"function"==typeof that.options.initCompleted&&that.options.initCompleted(that.$chart);var initEvent=$.Event("init.orgchart");that.$chart.trigger(initEvent);break initTime}}));mo.observe(this.$chartContainer[0],{childList:!0})},triggerLoadEvent:function($target,rel){var initEvent=$.Event("load-"+rel+".orgchart");$target.trigger(initEvent)},triggerShowEvent:function($target,rel){var initEvent=$.Event("show-"+rel+".orgchart");$target.trigger(initEvent)},triggerHideEvent:function($target,rel){var initEvent=$.Event("hide-"+rel+".orgchart");$target.trigger(initEvent)},attachExportButton:function(){var that=this,$exportBtn=$("<button>",{class:"oc-export-btn",text:this.options.exportButtonName,click:function(e){e.preventDefault(),that.export()}});this.$chartContainer.after($exportBtn)},setOptions:function(opts,val){return"string"==typeof opts&&("pan"===opts&&(val?this.bindPan():this.unbindPan()),"zoom"===opts&&(val?this.bindZoom():this.unbindZoom())),"object"==typeof opts&&(opts.data?this.init(opts):(void 0!==opts.pan&&(opts.pan?this.bindPan():this.unbindPan()),void 0!==opts.zoom&&(opts.zoom?this.bindZoom():this.unbindZoom()))),this},panStartHandler:function(e){var $chart=$(e.delegateTarget);if($(e.target).closest(".node").length||e.touches&&e.touches.length>1)$chart.data("panning",!1);else{$chart.css("cursor","move").data("panning",!0);var lastX=0,lastY=0,lastTf=$chart.css("transform");if("none"!==lastTf){var temp=lastTf.split(",");-1===lastTf.indexOf("3d")?(lastX=parseInt(temp[4]),lastY=parseInt(temp[5])):(lastX=parseInt(temp[12]),lastY=parseInt(temp[13]))}var startX=0,startY=0;if(e.targetTouches){if(1===e.targetTouches.length)startX=e.targetTouches[0].pageX-lastX,startY=e.targetTouches[0].pageY-lastY;else if(e.targetTouches.length>1)return}else startX=e.pageX-lastX,startY=e.pageY-lastY;$chart.on("mousemove touchmove",(function(e){if($chart.data("panning")){var newX=0,newY=0;if(e.targetTouches){if(1===e.targetTouches.length)newX=e.targetTouches[0].pageX-startX,newY=e.targetTouches[0].pageY-startY;else if(e.targetTouches.length>1)return}else newX=e.pageX-startX,newY=e.pageY-startY;var lastTf=$chart.css("transform");if("none"===lastTf)-1===lastTf.indexOf("3d")?$chart.css("transform","matrix(1, 0, 0, 1, "+newX+", "+newY+")"):$chart.css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+newX+", "+newY+", 0, 1)");else{var matrix=lastTf.split(",");-1===lastTf.indexOf("3d")?(matrix[4]=" "+newX,matrix[5]=" "+newY+")"):(matrix[12]=" "+newX,matrix[13]=" "+newY),$chart.css("transform",matrix.join(","))}}}))}},panEndHandler:function(e){e.data.chart.data("panning")&&e.data.chart.data("panning",!1).css("cursor","default").off("mousemove")},bindPan:function(){this.$chartContainer.css("overflow","hidden"),this.$chart.on("mousedown touchstart",this.panStartHandler),$(document).on("mouseup touchend",{chart:this.$chart},this.panEndHandler)},unbindPan:function(){this.$chartContainer.css("overflow","auto"),this.$chart.off("mousedown touchstart",this.panStartHandler),$(document).off("mouseup touchend",this.panEndHandler)},zoomWheelHandler:function(e){var oc=e.data.oc;e.preventDefault();var newScale=1+(e.originalEvent.deltaY>0?-.2:.2);oc.setChartScale(oc.$chart,newScale)},zoomStartHandler:function(e){if(e.touches&&2===e.touches.length){var oc=e.data.oc;oc.$chart.data("pinching",!0);var dist=oc.getPinchDist(e);oc.$chart.data("pinchDistStart",dist)}},zoomingHandler:function(e){var oc=e.data.oc;if(oc.$chart.data("pinching")){var dist=oc.getPinchDist(e);oc.$chart.data("pinchDistEnd",dist)}},zoomEndHandler:function(e){var oc=e.data.oc;if(oc.$chart.data("pinching")){oc.$chart.data("pinching",!1);var diff=oc.$chart.data("pinchDistEnd")-oc.$chart.data("pinchDistStart");diff>0?oc.setChartScale(oc.$chart,1.2):diff<0&&oc.setChartScale(oc.$chart,.8)}},bindZoom:function(){this.$chartContainer.on("wheel",{oc:this},this.zoomWheelHandler),this.$chartContainer.on("touchstart",{oc:this},this.zoomStartHandler),$(document).on("touchmove",{oc:this},this.zoomingHandler),$(document).on("touchend",{oc:this},this.zoomEndHandler)},unbindZoom:function(){this.$chartContainer.off("wheel",this.zoomWheelHandler),this.$chartContainer.off("touchstart",this.zoomStartHandler),$(document).off("touchmove",this.zoomingHandler),$(document).off("touchend",this.zoomEndHandler)},getPinchDist:function(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))},setChartScale:function($chart,newScale){var opts=$chart.data("options"),lastTf=$chart.css("transform"),matrix="",targetScale=1;"none"===lastTf?$chart.css("transform","scale("+newScale+","+newScale+")"):(matrix=lastTf.split(","),-1===lastTf.indexOf("3d")?(targetScale=Math.abs(window.parseFloat(matrix[3])*newScale))>opts.zoomoutLimit&&targetScale<opts.zoominLimit&&$chart.css("transform",lastTf+" scale("+newScale+","+newScale+")"):(targetScale=Math.abs(window.parseFloat(matrix[1])*newScale))>opts.zoomoutLimit&&targetScale<opts.zoominLimit&&$chart.css("transform",lastTf+" scale3d("+newScale+","+newScale+", 1)"))},buildJsonDS:function($li){var that=this,subObj={name:$li.contents().eq(0).text().trim(),relationship:($li.parent().parent().is("li")?"1":"0")+($li.siblings("li").length?1:0)+($li.children("ul").length?1:0)};return $.each($li.data(),(function(key,value){subObj[key]=value})),$li.children("ul").children().each((function(){subObj.children||(subObj.children=[]),subObj.children.push(that.buildJsonDS($(this)))})),subObj},attachRel:function(data,flags){var that=this;return data.relationship=flags+(data.children&&data.children.length>0?1:0),data.children&&data.children.forEach((function(item){that.attachRel(item,"1"+(data.children.length>1?1:0))})),data},loopChart:function($chart,includeNodeData){includeNodeData=null!==includeNodeData&&includeNodeData!==undefined&&includeNodeData;var that=this,$node=$chart.find(".node:first"),subObj={id:$node[0].id};return includeNodeData&&$.each($node.data("nodeData"),(function(key,value){subObj[key]=value})),$node.siblings(".nodes").children().each((function(){subObj.children||(subObj.children=[]),subObj.children.push(that.loopChart($(this),includeNodeData))})),subObj},getHierarchy:function(includeNodeData){if(includeNodeData=null!==includeNodeData&&includeNodeData!==undefined&&includeNodeData,void 0===this.$chart)return"Error: orgchart does not exist";if(!this.$chart.find(".node").length)return"Error: nodes do not exist";var valid=!0;return this.$chart.find(".node").each((function(){if(!this.id)return valid=!1,!1})),valid?this.loopChart(this.$chart,includeNodeData):"Error: All nodes of orghcart to be exported must have data-id attribute!"},getNodeState:function($node,relation){var $target={},isVerticalNode=!!$node.closest("vertical").length,relation;if("parent"===(relation=relation||"self")){if(isVerticalNode?($target=$node.closest("ul").parents("ul")).length||($target=$node.closest(".nodes")).length||($target=$node.closest(".vertical").siblings(":first")):$target=$node.closest(".nodes").siblings(".node"),$target.length)return $target.is(".hidden")||!$target.is(".hidden")&&$target.closest(".nodes").is(".hidden")||!$target.is(".hidden")&&$target.closest(".vertical").is(".hidden")?{exist:!0,visible:!1}:{exist:!0,visible:!0}}else if("children"===relation){if(($target=isVerticalNode?$node.parent().children("ul"):$node.siblings(".nodes")).length)return $target.is(".hidden")?{exist:!0,visible:!1}:{exist:!0,visible:!0}}else if("siblings"===relation){if(($target=isVerticalNode?$node.closest("ul"):$node.parent().siblings()).length&&(!isVerticalNode||$target.children("li").length>1))return $target.is(".hidden")||$target.parent().is(".hidden")||isVerticalNode&&$target.closest(".vertical").is(".hidden")?{exist:!0,visible:!1}:{exist:!0,visible:!0}}else if(($target=$node).length)return $target.closest(".nodes").length&&$target.closest(".nodes").is(".hidden")||$target.closest(".hierarchy").length&&$target.closest(".hierarchy").is(".hidden")||$target.closest(".vertical").length&&($target.closest(".nodes").is(".hidden")||$target.closest(".vertical").is(".hidden"))?{exist:!0,visible:!1}:{exist:!0,visible:!0};return{exist:!1,visible:!1}},getRelatedNodes:function($node,relation){return $node&&$node instanceof $&&$node.is(".node")?"parent"===relation?$node.closest(".nodes").siblings(".node"):"children"===relation?$node.siblings(".nodes").children(".hierarchy").find(".node:first"):"siblings"===relation?$node.closest(".hierarchy").siblings().find(".node:first"):$():$()},hideParentEnd:function(event){$(event.target).removeClass("sliding"),event.data.parent.addClass("hidden")},hideParent:function($node){var $parent=$node.closest(".nodes").siblings(".node");$parent.find(".spinner").length&&$node.closest(".orgchart").data("inAjax",!1),this.getNodeState($node,"siblings").visible&&this.hideSiblings($node),$node.parent().addClass("isAncestorsCollapsed"),this.getNodeState($parent).visible&&$parent.addClass("sliding slide-down").one("transitionend",{parent:$parent},this.hideParentEnd),this.getNodeState($parent,"parent").visible&&this.hideParent($parent)},showParentEnd:function(event){var $node=event.data.node;$(event.target).removeClass("sliding"),this.isInAction($node)&&this.switchVerticalArrow($node.children(".topEdge"))},showParent:function($node){var $parent=$node.closest(".nodes").siblings(".node").removeClass("hidden");$node.closest(".hierarchy").removeClass("isAncestorsCollapsed"),this.repaint($parent[0]),$parent.addClass("sliding").removeClass("slide-down").one("transitionend",{node:$node},this.showParentEnd.bind(this))},stopAjax:function($nodeLevel){$nodeLevel.find(".spinner").length&&$nodeLevel.closest(".orgchart").data("inAjax",!1)},isVisibleNode:function(index,elem){return this.getNodeState($(elem)).visible},hideChildrenEnd:function(event){var $node=event.data.node;event.data.animatedNodes.removeClass("sliding"),event.data.animatedNodes.closest(".nodes").addClass("hidden"),this.isInAction($node)&&this.switchVerticalArrow($node.children(".bottomEdge"))},hideChildren:function($node){$node.closest(".hierarchy").addClass("isChildrenCollapsed");var $lowerLevel=$node.siblings(".nodes");this.stopAjax($lowerLevel);var $animatedNodes=$lowerLevel.find(".node").filter(this.isVisibleNode.bind(this)),isVerticalDesc;$lowerLevel.is(".vertical")||$animatedNodes.closest(".hierarchy").addClass("isCollapsedDescendant"),($lowerLevel.is(".vertical")||$lowerLevel.find(".vertical").length)&&$animatedNodes.find(".oci-minus-square").removeClass("oci-minus-square").addClass("oci-plus-square"),this.repaint($animatedNodes.get(0)),$animatedNodes.addClass("sliding slide-up").eq(0).one("transitionend",{animatedNodes:$animatedNodes,lowerLevel:$lowerLevel,node:$node},this.hideChildrenEnd.bind(this))},showChildrenEnd:function(event){var $node=event.data.node;event.data.animatedNodes.removeClass("sliding"),this.isInAction($node)&&this.switchVerticalArrow($node.children(".bottomEdge"))},showChildren:function($node){var that=this;$node.closest(".hierarchy").removeClass("isChildrenCollapsed");var $levels=$node.siblings(".nodes"),isVerticalDesc=$levels.is(".vertical"),$animatedNodes=isVerticalDesc?$levels.removeClass("hidden").find(".node").filter(this.isVisibleNode.bind(this)):$levels.removeClass("hidden").children(".hierarchy").find(".node:first").filter(this.isVisibleNode.bind(this));isVerticalDesc||($animatedNodes.filter(":not(:only-child)").closest(".hierarchy").addClass("isChildrenCollapsed"),$animatedNodes.closest(".hierarchy").removeClass("isCollapsedDescendant")),this.repaint($animatedNodes.get(0)),$animatedNodes.addClass("sliding").removeClass("slide-up").eq(0).one("transitionend",{node:$node,animatedNodes:$animatedNodes},this.showChildrenEnd.bind(this))},hideSiblingsEnd:function(event){var $node=event.data.node,$nodeContainer=event.data.nodeContainer,direction=event.data.direction,$siblings=direction?"left"===direction?$nodeContainer.prevAll(":not(.hidden)"):$nodeContainer.nextAll(":not(.hidden)"):$nodeContainer.siblings();event.data.animatedNodes.removeClass("sliding"),$siblings.find(".node:gt(0)").filter(this.isVisibleNode.bind(this)).removeClass("slide-left slide-right").addClass("slide-up"),$siblings.find(".nodes, .vertical").addClass("hidden").end().addClass("hidden"),this.isInAction($node)&&this.switchHorizontalArrow($node)},hideSiblings:function($node,direction){var that=this,$nodeContainer=$node.closest(".hierarchy").addClass("isSiblingsCollapsed");$nodeContainer.siblings().find(".spinner").length&&$node.closest(".orgchart").data("inAjax",!1),direction?"left"===direction?$nodeContainer.addClass("left-sibs").prevAll(".isSiblingsCollapsed").removeClass("isSiblingsCollapsed left-sibs").end().prevAll().addClass("isCollapsedSibling isChildrenCollapsed").find(".node").filter(this.isVisibleNode.bind(this)).addClass("sliding slide-right"):$nodeContainer.addClass("right-sibs").nextAll(".isSiblingsCollapsed").removeClass("isSiblingsCollapsed right-sibs").end().nextAll().addClass("isCollapsedSibling isChildrenCollapsed").find(".node").filter(this.isVisibleNode.bind(this)).addClass("sliding slide-left"):($nodeContainer.prevAll().find(".node").filter(this.isVisibleNode.bind(this)).addClass("sliding slide-right"),$nodeContainer.nextAll().find(".node").filter(this.isVisibleNode.bind(this)).addClass("sliding slide-left"),$nodeContainer.siblings().addClass("isCollapsedSibling isChildrenCollapsed"));var $animatedNodes=$nodeContainer.siblings().find(".sliding");$animatedNodes.eq(0).one("transitionend",{node:$node,nodeContainer:$nodeContainer,direction:direction,animatedNodes:$animatedNodes},this.hideSiblingsEnd.bind(this))},showSiblingsEnd:function(event){var $node=event.data.node;event.data.visibleNodes.removeClass("sliding"),this.isInAction($node)&&(this.switchHorizontalArrow($node),$node.children(".topEdge").removeClass("oci-chevron-up").addClass("oci-chevron-down"))},showRelatedParentEnd:function(event){$(event.target).removeClass("sliding")},showSiblings:function($node,direction){var that=this,$siblings=$(),$nodeContainer=$node.closest(".hierarchy");$siblings=direction?"left"===direction?$nodeContainer.prevAll().removeClass("hidden"):$nodeContainer.nextAll().removeClass("hidden"):$node.closest(".hierarchy").siblings().removeClass("hidden");var $upperLevel=$node.closest(".nodes").siblings(".node");direction?($nodeContainer.removeClass(direction+"-sibs"),$nodeContainer.is("[class*=-sibs]")||$nodeContainer.removeClass("isSiblingsCollapsed"),$siblings.removeClass("isCollapsedSibling "+direction+"-sibs")):($node.closest(".hierarchy").removeClass("isSiblingsCollapsed"),$siblings.removeClass("isCollapsedSibling")),this.getNodeState($node,"parent").visible||($node.closest(".hierarchy").removeClass("isAncestorsCollapsed"),$upperLevel.removeClass("hidden"),this.repaint($upperLevel[0]),$upperLevel.addClass("sliding").removeClass("slide-down").one("transitionend",this.showRelatedParentEnd));var $visibleNodes=$siblings.find(".node").filter(this.isVisibleNode.bind(this));this.repaint($visibleNodes.get(0)),$visibleNodes.addClass("sliding").removeClass("slide-left slide-right"),$visibleNodes.eq(0).one("transitionend",{node:$node,visibleNodes:$visibleNodes},this.showSiblingsEnd.bind(this))},startLoading:function($edge){var $chart=this.$chart;return(void 0===$chart.data("inAjax")||!0!==$chart.data("inAjax"))&&($edge.addClass("hidden"),$edge.parent().append('<i class="oci oci-spinner spinner"></i>').children().not(".spinner").css("opacity",.2),$chart.data("inAjax",!0),$(".oc-export-btn").prop("disabled",!0),!0)},endLoading:function($edge){var $node=$edge.parent();$edge.removeClass("hidden"),$node.find(".spinner").remove(),$node.children().removeAttr("style"),this.$chart.data("inAjax",!1),$(".oc-export-btn").prop("disabled",!1)},isInAction:function($node){return $node.children(".edge").attr("class").indexOf("oci-")>-1},switchVerticalArrow:function($arrow){$arrow.toggleClass("oci-chevron-up").toggleClass("oci-chevron-down")},switchHorizontalArrow:function($node){var opts=this.options;if(opts.toggleSiblingsResp&&(void 0===opts.ajaxURL||$node.closest(".nodes").data("siblingsLoaded"))){var $prevSib=$node.parent().prev();$prevSib.length&&($prevSib.is(".hidden")?$node.children(".leftEdge").addClass("oci-chevron-left").removeClass("oci-chevron-right"):$node.children(".leftEdge").addClass("oci-chevron-right").removeClass("oci-chevron-left"));var $nextSib=$node.parent().next();$nextSib.length&&($nextSib.is(".hidden")?$node.children(".rightEdge").addClass("oci-chevron-right").removeClass("oci-chevron-left"):$node.children(".rightEdge").addClass("oci-chevron-left").removeClass("oci-chevron-right"))}else{var $sibs=$node.parent().siblings(),sibsVisible=!!$sibs.length&&!$sibs.is(".hidden");$node.children(".leftEdge").toggleClass("oci-chevron-right",sibsVisible).toggleClass("oci-chevron-left",!sibsVisible),$node.children(".rightEdge").toggleClass("oci-chevron-left",sibsVisible).toggleClass("oci-chevron-right",!sibsVisible)}},repaint:function(node){node&&(node.style.offsetWidth=node.offsetWidth)},nodeEnterLeaveHandler:function(event){var $node=$(event.delegateTarget),flag=!1;if($node.closest(".nodes.vertical").length){var $toggleBtn=$node.children(".toggleBtn");"mouseenter"===event.type?$node.children(".toggleBtn").length&&(flag=this.getNodeState($node,"children").visible,$toggleBtn.toggleClass("oci-plus-square",!flag).toggleClass("oci-minus-square",flag)):$toggleBtn.removeClass("oci-plus-square oci-minus-square")}else{var $topEdge=$node.children(".topEdge"),$rightEdge=$node.children(".rightEdge"),$bottomEdge=$node.children(".bottomEdge"),$leftEdge=$node.children(".leftEdge");"mouseenter"===event.type?($topEdge.length&&(flag=this.getNodeState($node,"parent").visible,$topEdge.toggleClass("oci-chevron-up",!flag).toggleClass("oci-chevron-down",flag)),$bottomEdge.length&&(flag=this.getNodeState($node,"children").visible,$bottomEdge.toggleClass("oci-chevron-down",!flag).toggleClass("oci-chevron-up",flag)),$leftEdge.length&&this.switchHorizontalArrow($node)):$node.children(".edge").removeClass("oci-chevron-up oci-chevron-down oci-chevron-right oci-chevron-left")}},nodeClickHandler:function(event){this.$chart.find(".focused").removeClass("focused"),$(event.delegateTarget).addClass("focused")},loadNodes:function(rel,url,$edge){var that=this,opts=this.options;$.ajax({url:url,dataType:"json"}).done((function(data){that.$chart.data("inAjax")&&("parent"===rel?$.isEmptyObject(data)||that.addParent($edge.parent(),data):"children"===rel?data.children.length&&that.addChildren($edge.parent(),data[rel]):that.addSiblings($edge.parent(),data.siblings?data.siblings:data),that.triggerLoadEvent($edge.parent(),rel))})).fail((function(){console.log("Failed to get "+rel+" data")})).always((function(){that.endLoading($edge)}))},HideFirstParentEnd:function(event){var $topEdge=event.data.topEdge,$node=$topEdge.parent();this.isInAction($node)&&(this.switchVerticalArrow($topEdge),this.switchHorizontalArrow($node))},topEdgeClickHandler:function(event){event.stopPropagation();var that=this,$topEdge=$(event.target),$node=$(event.delegateTarget),parentState=this.getNodeState($node,"parent");if(parentState.exist){var $parent=$node.closest(".nodes").siblings(".node");if($parent.is(".sliding"))return;parentState.visible?(this.hideParent($node),$parent.one("transitionend",{topEdge:$topEdge},this.HideFirstParentEnd.bind(this)),this.triggerHideEvent($node,"parent")):(this.showParent($node),this.triggerShowEvent($node,"parent"))}else if(this.startLoading($topEdge)){var opts=this.options,url=$.isFunction(opts.ajaxURL.parent)?opts.ajaxURL.parent($node.data("nodeData")):opts.ajaxURL.parent+$node[0].id;this.loadNodes("parent",url,$topEdge)}},bottomEdgeClickHandler:function(event){event.stopPropagation();var $bottomEdge=$(event.target),$node=$(event.delegateTarget),childrenState=this.getNodeState($node,"children");if(childrenState.exist){var $children;if($node.siblings(".nodes").children().children(".node").is(".sliding"))return;childrenState.visible?(this.hideChildren($node),this.triggerHideEvent($node,"children")):(this.showChildren($node),this.triggerShowEvent($node,"children"))}else if(this.startLoading($bottomEdge)){var opts=this.options,url=$.isFunction(opts.ajaxURL.children)?opts.ajaxURL.children($node.data("nodeData")):opts.ajaxURL.children+$node[0].id;this.loadNodes("children",url,$bottomEdge)}},hEdgeClickHandler:function(event){event.stopPropagation();var $hEdge=$(event.target),$node=$(event.delegateTarget),opts=this.options,siblingsState=this.getNodeState($node,"siblings");if(siblingsState.exist){var $siblings;if($node.closest(".hierarchy").siblings().find(".sliding").length)return;if(opts.toggleSiblingsResp){var $prevSib=$node.closest(".hierarchy").prev(),$nextSib=$node.closest(".hierarchy").next();$hEdge.is(".leftEdge")?$prevSib.is(".hidden")?(this.showSiblings($node,"left"),this.triggerShowEvent($node,"siblings")):(this.hideSiblings($node,"left"),this.triggerHideEvent($node,"siblings")):$nextSib.is(".hidden")?(this.showSiblings($node,"right"),this.triggerShowEvent($node,"siblings")):(this.hideSiblings($node,"right"),this.triggerHideEvent($node,"siblings"))}else siblingsState.visible?(this.hideSiblings($node),this.triggerHideEvent($node,"siblings")):(this.showSiblings($node),this.triggerShowEvent($node,"siblings"))}else if(this.startLoading($hEdge)){var nodeId=$node[0].id,url=this.getNodeState($node,"parent").exist?$.isFunction(opts.ajaxURL.siblings)?opts.ajaxURL.siblings($node.data("nodeData")):opts.ajaxURL.siblings+nodeId:$.isFunction(opts.ajaxURL.families)?opts.ajaxURL.families($node.data("nodeData")):opts.ajaxURL.families+nodeId;this.loadNodes("siblings",url,$hEdge)}},expandVNodesEnd:function(event){event.data.vNodes.removeClass("sliding")},collapseVNodesEnd:function(event){event.data.vNodes.removeClass("sliding").closest("ul").addClass("hidden")},toggleVNodes:function(event){var $toggleBtn=$(event.target),$descWrapper=$toggleBtn.parent().next(),$descendants=$descWrapper.find(".node"),$children=$descWrapper.children().children(".node");$children.is(".sliding")||($toggleBtn.toggleClass("oci-plus-square oci-minus-square"),$descendants.eq(0).is(".slide-up")?($descWrapper.removeClass("hidden"),this.repaint($children.get(0)),$children.addClass("sliding").removeClass("slide-up").eq(0).one("transitionend",{vNodes:$children},this.expandVNodesEnd)):($descendants.addClass("sliding slide-up").eq(0).one("transitionend",{vNodes:$descendants},this.collapseVNodesEnd),$descendants.find(".toggleBtn").removeClass("oci-minus-square").addClass("oci-plus-square")))},createGhostNode:function(event){var $nodeDiv=$(event.target),opts=this.options,origEvent=event.originalEvent,isFirefox=/firefox/.test(window.navigator.userAgent.toLowerCase()),ghostNode,nodeCover;if(document.querySelector(".ghost-node"))ghostNode=$nodeDiv.closest(".orgchart").children(".ghost-node").get(0),nodeCover=$(ghostNode).children().get(0);else{if(!(ghostNode=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList)return;ghostNode.classList.add("ghost-node"),nodeCover=document.createElementNS("http://www.w3.org/2000/svg","rect"),ghostNode.appendChild(nodeCover),$nodeDiv.closest(".orgchart").append(ghostNode)}var transValues=$nodeDiv.closest(".orgchart").css("transform").split(","),isHorizontal="t2b"===opts.direction||"b2t"===opts.direction,scale=Math.abs(window.parseFloat(isHorizontal?transValues[0].slice(transValues[0].indexOf("(")+1):transValues[1]));ghostNode.setAttribute("width",isHorizontal?$nodeDiv.outerWidth(!1):$nodeDiv.outerHeight(!1)),ghostNode.setAttribute("height",isHorizontal?$nodeDiv.outerHeight(!1):$nodeDiv.outerWidth(!1)),nodeCover.setAttribute("x",5*scale),nodeCover.setAttribute("y",5*scale),nodeCover.setAttribute("width",120*scale),nodeCover.setAttribute("height",40*scale),nodeCover.setAttribute("rx",4*scale),nodeCover.setAttribute("ry",4*scale),nodeCover.setAttribute("stroke-width",1*scale);var xOffset=origEvent.offsetX*scale,yOffset=origEvent.offsetY*scale;if("l2r"===opts.direction?(xOffset=origEvent.offsetY*scale,yOffset=origEvent.offsetX*scale):"r2l"===opts.direction?(xOffset=$nodeDiv.outerWidth(!1)-origEvent.offsetY*scale,yOffset=origEvent.offsetX*scale):"b2t"===opts.direction&&(xOffset=$nodeDiv.outerWidth(!1)-origEvent.offsetX*scale,yOffset=$nodeDiv.outerHeight(!1)-origEvent.offsetY*scale),isFirefox){nodeCover.setAttribute("fill","rgb(255, 255, 255)"),nodeCover.setAttribute("stroke","rgb(191, 0, 0)");var ghostNodeWrapper=document.createElement("img");ghostNodeWrapper.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(ghostNode),origEvent.dataTransfer.setDragImage(ghostNodeWrapper,xOffset,yOffset)}else origEvent.dataTransfer.setDragImage&&origEvent.dataTransfer.setDragImage(ghostNode,xOffset,yOffset)},filterAllowedDropNodes:function($dragged){var opts=this.options,draggingNode=$dragged.closest("[draggable]").hasClass("node"),$dragZone=$dragged.closest(".nodes").siblings(".node"),$dragHier=$dragged.closest(".hierarchy").find(".node");this.$chart.data("dragged",$dragged).find(".node").each((function(index,node){draggingNode&&-1!==$dragHier.index(node)||(opts.dropCriteria?opts.dropCriteria($dragged,$dragZone,$(node))&&$(node).addClass("allowedDrop"):$(node).addClass("allowedDrop"))}))},dragstartHandler:function(event){event.originalEvent.dataTransfer.setData("text/html","hack for firefox"),"none"!==this.$chart.css("transform")&&this.createGhostNode(event),this.filterAllowedDropNodes($(event.target))},dragoverHandler:function(event){$(event.delegateTarget).is(".allowedDrop")?event.preventDefault():event.originalEvent.dataTransfer.dropEffect="none"},dragendHandler:function(event){this.$chart.find(".allowedDrop").removeClass("allowedDrop")},dropHandler:function(event){var $dropZone=$(event.delegateTarget),$dragged=this.$chart.data("dragged");if($dragged.hasClass("node")){if($dropZone.hasClass("allowedDrop")){var $dragZone=$dragged.closest(".nodes").siblings(".node"),dropEvent=$.Event("nodedrop.orgchart");if(this.$chart.trigger(dropEvent,{draggedNode:$dragged,dragZone:$dragZone,dropZone:$dropZone}),!dropEvent.isDefaultPrevented()){if($dropZone.siblings(".nodes").length){var horizontalEdges='<i class="edge horizontalEdge rightEdge oci"></i><i class="edge horizontalEdge leftEdge oci"></i>';$dragged.find(".horizontalEdge").length||$dragged.append(horizontalEdges),$dropZone.siblings(".nodes").append($dragged.closest(".hierarchy"));var $dropSibs=$dragged.closest(".hierarchy").siblings().find(".node:first");1===$dropSibs.length&&$dropSibs.append(horizontalEdges)}else $dropZone.append('<i class="edge verticalEdge bottomEdge oci"></i>').after('<ul class="nodes"></ul>').siblings(".nodes").append($dragged.find(".horizontalEdge").remove().end().closest(".hierarchy")),$dropZone.children(".title").length&&$dropZone.children(".title").prepend('<i class="oci '+this.$chart.data("options").parentNodeSymbol+' symbol"></i>');1===$dragZone.siblings(".nodes").children(".hierarchy").length?$dragZone.siblings(".nodes").children(".hierarchy").find(".node:first").find(".horizontalEdge").remove():0===$dragZone.siblings(".nodes").children(".hierarchy").length&&$dragZone.find(".bottomEdge, .symbol").remove().end().siblings(".nodes").remove()}}}else this.$chart.triggerHandler({type:"otherdropped.orgchart",draggedItem:$dragged,dropZone:$dropZone})},touchstartHandler:function(event){this.touchHandled||event.touches&&event.touches.length>1||(this.touchHandled=!0,this.touchMoved=!1,event.preventDefault())},touchmoveHandler:function(event){if(this.touchHandled&&!(event.touches&&event.touches.length>1)){event.preventDefault(),this.touchMoved||(this.filterAllowedDropNodes($(event.currentTarget)),this.touchDragImage=this.createDragImage(event,this.$chart.data("dragged")[0])),this.touchMoved=!0,this.moveDragImage(event,this.touchDragImage);var $touching,$touchingNodes=$(document.elementFromPoint(event.touches[0].clientX,event.touches[0].clientY)).closest("div.node");if($touchingNodes.length>0){var touchingNodeElement=$touchingNodes[0];$touchingNodes.is(".allowedDrop")?this.touchTargetNode=touchingNodeElement:this.touchTargetNode=null}else this.touchTargetNode=null}},touchendHandler:function(event){if(this.touchHandled){if(this.destroyDragImage(),this.touchMoved){if(this.touchTargetNode){var fakeEventForDropHandler={delegateTarget:this.touchTargetNode};this.dropHandler(fakeEventForDropHandler),this.touchTargetNode=null}this.dragendHandler(event)}else{var firstTouch=event.changedTouches[0],fakeMouseClickEvent=document.createEvent("MouseEvents");fakeMouseClickEvent.initMouseEvent("click",!0,!0,window,1,firstTouch.screenX,firstTouch.screenY,firstTouch.clientX,firstTouch.clientY,event.ctrlKey,event.altKey,event.shiftKey,event.metaKey,0,null),event.target.dispatchEvent(fakeMouseClickEvent)}this.touchHandled=!1}},createDragImage:function(event,source){var dragImage=source.cloneNode(!0);this.copyStyle(source,dragImage),dragImage.style.top=dragImage.style.left="-9999px";var sourceRectangle=source.getBoundingClientRect(),sourcePoint=this.getTouchPoint(event);return this.touchDragImageOffset={x:sourcePoint.x-sourceRectangle.left,y:sourcePoint.y-sourceRectangle.top},dragImage.style.opacity="0.5",document.body.appendChild(dragImage),dragImage},destroyDragImage:function(){this.touchDragImage&&this.touchDragImage.parentElement&&this.touchDragImage.parentElement.removeChild(this.touchDragImage),this.touchDragImageOffset=null,this.touchDragImage=null},copyStyle:function(src,dst){var badAttributes;if(["id","class","style","draggable"].forEach((function(att){dst.removeAttribute(att)})),src instanceof HTMLCanvasElement){var cSrc=src,cDst=dst;cDst.width=cSrc.width,cDst.height=cSrc.height,cDst.getContext("2d").drawImage(cSrc,0,0)}for(var cs=getComputedStyle(src),i=0;i<cs.length;i++){var key=cs[i];key.indexOf("transition")<0&&(dst.style[key]=cs[key])}dst.style.pointerEvents="none";for(var i=0;i<src.children.length;i++)this.copyStyle(src.children[i],dst.children[i])},getTouchPoint:function(event){return event&&event.touches&&(event=event.touches[0]),{x:event.clientX,y:event.clientY}},moveDragImage:function(event,image){if(event&&image){var orgChartMaster=this;requestAnimationFrame((function(){var pt=orgChartMaster.getTouchPoint(event),s=image.style;s.position="absolute",s.pointerEvents="none",s.zIndex="999999",orgChartMaster.touchDragImageOffset&&(s.left=Math.round(pt.x-orgChartMaster.touchDragImageOffset.x)+"px",s.top=Math.round(pt.y-orgChartMaster.touchDragImageOffset.y)+"px")}))}},bindDragDrop:function($node){$node.on("dragstart",this.dragstartHandler.bind(this)).on("dragover",this.dragoverHandler.bind(this)).on("dragend",this.dragendHandler.bind(this)).on("drop",this.dropHandler.bind(this)).on("touchstart",this.touchstartHandler.bind(this)).on("touchmove",this.touchmoveHandler.bind(this)).on("touchend",this.touchendHandler.bind(this))},createNode:function(data){var that=this,opts=this.options,level=data.level;data.children&&data[opts.nodeId]&&$.each(data.children,(function(index,child){child.parentId=data[opts.nodeId]}));var $nodeDiv=$("<div"+(opts.draggable?' draggable="true"':"")+(data[opts.nodeId]?' id="'+data[opts.nodeId]+'"':"")+(data.parentId?' data-parent="'+data.parentId+'"':"")+">").addClass("node "+(data.className||"")+(level>opts.visibleLevel?" slide-up":""));opts.nodeTemplate?$nodeDiv.append(opts.nodeTemplate(data)):$nodeDiv.append('<div class="title">'+data[opts.nodeTitle]+"</div>").append(void 0!==opts.nodeContent?'<div class="content">'+(data[opts.nodeContent]||"")+"</div>":"");var nodeData=$.extend({},data);delete nodeData.children,$nodeDiv.data("nodeData",nodeData);var flags=data.relationship||"";return opts.verticalLevel&&level>=opts.verticalLevel?level+1>opts.verticalLevel&&Number(flags.substr(2,1))&&$nodeDiv.append('<i class="toggleBtn oci"></i>').children(".title").prepend('<i class="oci '+opts.parentNodeSymbol+' symbol"></i>'):(Number(flags.substr(0,1))&&$nodeDiv.append('<i class="edge verticalEdge topEdge oci"></i>'),Number(flags.substr(1,1))&&$nodeDiv.append('<i class="edge horizontalEdge rightEdge oci"></i><i class="edge horizontalEdge leftEdge oci"></i>'),Number(flags.substr(2,1))&&$nodeDiv.append('<i class="edge verticalEdge bottomEdge oci"></i>').children(".title").prepend('<i class="oci '+opts.parentNodeSymbol+' symbol"></i>')),$nodeDiv.on("mouseenter mouseleave",this.nodeEnterLeaveHandler.bind(this)),$nodeDiv.on("click",this.nodeClickHandler.bind(this)),$nodeDiv.on("click",".topEdge",this.topEdgeClickHandler.bind(this)),$nodeDiv.on("click",".bottomEdge",this.bottomEdgeClickHandler.bind(this)),$nodeDiv.on("click",".leftEdge, .rightEdge",this.hEdgeClickHandler.bind(this)),$nodeDiv.on("click",".toggleBtn",this.toggleVNodes.bind(this)),opts.draggable&&(this.bindDragDrop($nodeDiv),this.touchHandled=!1,this.touchMoved=!1,this.touchTargetNode=null),opts.createNode&&opts.createNode($nodeDiv,data),$nodeDiv},buildHierarchy:function($appendTo,data){var that=this,opts=this.options,level=0;if(level=data.level?data.level:data.level=$appendTo.parentsUntil(".orgchart",".nodes").length,Object.keys(data).length>2){var $nodeDiv=this.createNode(data);opts.verticalLevel&&opts.verticalLevel,$appendTo.append($nodeDiv)}if(data.children&&data.children.length){var isHidden=level+1>opts.visibleLevel||data.collapsed!==undefined&&data.collapsed,isVerticalLayer,$nodesLayer;opts.verticalLevel&&level+1>=opts.verticalLevel?($nodesLayer=$('<ul class="nodes">'),isHidden&&level+1>=opts.verticalLevel&&$nodesLayer.addClass("hidden"),level+1===opts.verticalLevel?$appendTo.addClass("hybrid").append($nodesLayer.addClass("vertical")):$appendTo.append($nodesLayer)):($nodesLayer=$('<ul class="nodes'+(isHidden?" hidden":"")+'">'),2===Object.keys(data).length?$appendTo.append($nodesLayer):(isHidden&&$appendTo.addClass("isChildrenCollapsed"),$appendTo.append($nodesLayer))),$.each(data.children,(function(){var $nodeCell=$('<li class="hierarchy">');$nodesLayer.append($nodeCell),this.level=level+1,that.buildHierarchy($nodeCell,this)}))}},buildChildNode:function($appendTo,data){this.buildHierarchy($appendTo,{children:data})},addChildren:function($node,data){this.buildChildNode($node.closest(".hierarchy"),data),$node.find(".symbol").length||$node.children(".title").prepend('<i class="oci '+this.options.parentNodeSymbol+' symbol"></i>'),$node.closest(".nodes.vertical").length?$node.children(".toggleBtn").length||$node.append('<i class="toggleBtn oci"></i>'):$node.children(".bottomEdge").length||$node.append('<i class="edge verticalEdge bottomEdge oci"></i>'),this.isInAction($node)&&this.switchVerticalArrow($node.children(".bottomEdge"))},buildParentNode:function($currentRoot,data){data.relationship=data.relationship||"001";var $newRootWrapper=$('<ul class="nodes"><li class="hierarchy"></li></ul>').find(".hierarchy").append(this.createNode(data)).end();this.$chart.prepend($newRootWrapper).find(".hierarchy:first").append($currentRoot.closest("ul").addClass("nodes"))},addParent:function($currentRoot,data){this.buildParentNode($currentRoot,data),$currentRoot.children(".topEdge").length||$currentRoot.children(".title").after('<i class="edge verticalEdge topEdge oci"></i>'),this.isInAction($currentRoot)&&this.switchVerticalArrow($currentRoot.children(".topEdge"))},buildSiblingNode:function($nodeChart,data){var newSiblingCount=$.isArray(data)?data.length:data.children.length,existingSibligCount=$nodeChart.parent().is(".nodes")?$nodeChart.siblings().length+1:1,siblingCount=existingSibligCount+newSiblingCount,insertPostion=siblingCount>1?Math.floor(siblingCount/2-1):0;if($nodeChart.closest(".nodes").parent().is(".hierarchy")){this.buildChildNode($nodeChart.parent().closest(".hierarchy"),data);var $siblings=$nodeChart.parent().closest(".hierarchy").children(".nodes:last").children(".hierarchy");existingSibligCount>1?$siblings.eq(0).before($nodeChart.siblings().addBack().unwrap()):$siblings.eq(insertPostion).after($nodeChart.unwrap())}else this.buildHierarchy($nodeChart.parent().prepend($('<li class="hierarchy">')).children(".hierarchy:first"),data),$nodeChart.prevAll(".hierarchy").children(".nodes").children().eq(insertPostion).after($nodeChart)},addSiblings:function($node,data){this.buildSiblingNode($node.closest(".hierarchy"),data),$node.closest(".nodes").data("siblingsLoaded",!0),$node.children(".leftEdge").length||$node.children(".topEdge").after('<i class="edge horizontalEdge rightEdge oci"></i><i class="edge horizontalEdge leftEdge oci"></i>'),this.isInAction($node)&&(this.switchHorizontalArrow($node),$node.children(".topEdge").removeClass("oci-chevron-up").addClass("oci-chevron-down"))},removeNodes:function($node){var $wrapper=$node.closest(".hierarchy").parent();$wrapper.parent().is(".hierarchy")?this.getNodeState($node,"siblings").exist?($node.closest(".hierarchy").remove(),1===$wrapper.children().length&&$wrapper.find(".node:first .horizontalEdge").remove()):$wrapper.siblings(".node").find(".bottomEdge").remove().end().end().remove():$wrapper.closest(".orgchart").remove()},hideDropZones:function(){var orgChartObj=this;this.$chart.find(".allowedDrop").removeClass("allowedDrop")},showDropZones:function(dragged){var orgChartObj=this;this.$chart.find(".node").each((function(index,node){$(node).addClass("allowedDrop")})),this.$chart.data("dragged",$(dragged))},processExternalDrop:function(dropZone,dragged){var droppedOnNode;dragged&&this.$chart.data("dragged",$(dragged)),dropZone.closest(".node").triggerHandler({type:"drop"})},exportPDF:function(canvas,exportFilename){var doc={},docWidth=Math.floor(canvas.width),docHeight=Math.floor(canvas.height);window.jsPDF||(window.jsPDF=window.jspdf.jsPDF),(doc=docWidth>docHeight?new jsPDF({orientation:"landscape",unit:"px",format:[docWidth,docHeight]}):new jsPDF({orientation:"portrait",unit:"px",format:[docHeight,docWidth]})).addImage(canvas.toDataURL(),"png",0,0),doc.save(exportFilename+".pdf")},exportPNG:function(canvas,exportFilename){var that=this,isWebkit="WebkitAppearance"in document.documentElement.style,isFf=!!window.sidebar,isEdge="Microsoft Internet Explorer"===navigator.appName||"Netscape"===navigator.appName&&navigator.appVersion.indexOf("Edge")>-1,$chartContainer=this.$chartContainer;if(!isWebkit&&!isFf||isEdge)window.navigator.msSaveBlob(canvas.msToBlob(),exportFilename+".png");else{var selector=".oci-download-btn"+(""!==this.options.chartClass?"."+this.options.chartClass:"");$chartContainer.find(selector).length||$chartContainer.append('<a class="oci-download-btn'+(""!==this.options.chartClass?" "+this.options.chartClass:"")+'" download="'+exportFilename+'.png"></a>'),$chartContainer.find(selector).attr("href",canvas.toDataURL())[0].click()}},export:function(exportFilename,exportFileextension){var that=this;if(exportFilename=void 0!==exportFilename?exportFilename:this.options.exportFilename,exportFileextension=void 0!==exportFileextension?exportFileextension:this.options.exportFileextension,$(this).children(".spinner").length)return!1;var $chartContainer=this.$chartContainer,$mask=$chartContainer.find(".mask");$mask.length?$mask.removeClass("hidden"):$chartContainer.append('<div class="mask"><i class="oci oci-spinner spinner"></i></div>');var sourceChart=$chartContainer.addClass("canvasContainer").find('.orgchart:not(".hidden")').get(0),flag="l2r"===that.options.direction||"r2l"===that.options.direction;html2canvas(sourceChart,{width:flag?sourceChart.clientHeight:sourceChart.clientWidth,height:flag?sourceChart.clientWidth:sourceChart.clientHeight,onclone:function(cloneDoc){$(cloneDoc).find(".canvasContainer").css("overflow","visible").find('.orgchart:not(".hidden"):first').css("transform","")}}).then((function(canvas){$chartContainer.find(".mask").addClass("hidden"),"pdf"===exportFileextension.toLowerCase()?that.exportPDF(canvas,exportFilename):that.exportPNG(canvas,exportFilename),$chartContainer.removeClass("canvasContainer")}),(function(){$chartContainer.removeClass("canvasContainer")}))}},$.fn.orgchart=function(opts){return new OrgChart(this,opts).init()}}));